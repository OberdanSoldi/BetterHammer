# This is a basic workflow to help you get started with Actions

on:
  push:
    tags:
      - "v*"

name: Adjust version on tag

jobs:
  build_release:
    name: Adjust version on tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.PUSH_TO_BRANCH }}
          ref: 'master'

      - name: Get the version
        id: get_version
        run: |
          echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
          echo ::set-output name=VERSION_NUMBER::${GITHUB_REF/refs\/tags\/v/}
          echo ::set-output name=VERSION_WITHOUT_BETA::${VERSION_NUMBER/-.*/}

      # Get build commands
      - name: Get build commands
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
          echo "deb https://download.mono-project.com/repo/ubuntu stable-bionic main" | sudo tee /etc/apt/sources.list.d/mono-official-stable.list
          wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y mono-roslyn mono-complete mono-dbg msbuild unzip dirmngr dotnet-sdk-5.0 dotnet-runtime-5.0

      # Got version and repo, change version inside and push again
      - name: Change packages.config version
        run: |
          sed -e 's/JotunnLib" version=".*" t/JotunnLib" version="${{ steps.get_version.outputs.VERSION }}" t/' JotunnModStub/packages.config > JotunnModStub/p2.c && mv JotunnModStub/p2.c JotunnModStub/packages.config

      # Install NuGet dependencies
      - name: Install NuGet dependencies
        run: |
          nuget restore JotunnModStub.sln
          dotnet restore JotunnModStub/JotunnModStub.csproj

      # Build DLLs
      - name: Build solution
        run: |
          msbuild JotunnModStub.sln /p:Configuration=Debug

      # Push changes back to master
      - name: Push version update to prod
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add JotunnModStub/JotunnModSub.csproj
          git add JotunnModStub/packages.config
          git commit -m "deploy: Released ${{ steps.get_version.outputs.VERSION }}"
          git push https://${{ secrets.PUSH_TO_BRANCH }}@github.com/Valheim-Modding/JotunnModStub HEAD:master
